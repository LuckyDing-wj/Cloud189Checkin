name: Cloud check in action
on:
  push:
    branches:
      - main
  watch:
    types: started
  workflow_dispatch:
  schedule:
    - cron: 35 2 * * *
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: user
    steps:
      - name: ğŸ”€ random delay 0-300 seconds
        run: sleep $((RANDOM % 301))

      - name: ğŸ”Œ Check out code
        uses: actions/checkout@v4

      - name: ğŸ”¨ Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: ğŸ‘¾ Check if Debug is true
        if: vars.debug == '1'
        run: |
          echo "CLOUD189_VERBOSE=1" >> $GITHUB_ENV

      # --- ä¿®æ”¹å¼€å§‹ ---
      # 1. åˆå¹¶ restore å’Œ save æ­¥éª¤ä¸ºä¸€ä¸ªï¼Œè¿™æ˜¯æœ€æ ¸å¿ƒçš„ä¿®æ”¹ã€‚
      # 2. ä¿®æ­£äº† `key` çš„ç”Ÿæˆé€»è¾‘ï¼Œç°åœ¨å®ƒä¼šæ ¹æ® `.token` æ–‡ä»¶æœ¬èº«çš„å†…å®¹æ¥ç”Ÿæˆå“ˆå¸Œå€¼ã€‚
      #    è¿™æ„å‘³ç€åªæœ‰å½“ `npm start` æˆåŠŸè¿è¡Œå¹¶æ›´æ–°äº† `.token` æ–‡ä»¶åï¼Œæ‰ä¼šä¿å­˜ä¸€ä¸ªæ–°çš„ç¼“å­˜ã€‚
      - name: ğŸ“¹ Cache and Restore Cookie
        id: cache-cookie
        uses: actions/cache@v4
        with:
          # è·¯å¾„ä¾ç„¶æ˜¯ .token æ–‡ä»¶
          path: .token
          # ä¸» keyï¼šåŸºäºæ“ä½œç³»ç»Ÿå’Œ .token æ–‡ä»¶çš„å†…å®¹å“ˆå¸Œã€‚
          # å¦‚æœ .token æ–‡ä»¶ä¸å­˜åœ¨æˆ–å†…å®¹æœªå˜ï¼Œå“ˆå¸Œå€¼ä¹Ÿä¸€æ ·ï¼Œä¼šå‘½ä¸­æ—§ç¼“å­˜ã€‚
          key: ${{ runner.os }}-cache-token-${{ hashFiles('.token') }}
          # å¤‡ç”¨ key (restore-keys)ï¼šå½“ä¸» key æ‰¾ä¸åˆ°æ—¶ï¼Œä½¿ç”¨è¿™ä¸ªæ›´é€šç”¨çš„ key æ¥å°è¯•æ¢å¤ä¸€ä¸ªæœ€è¿‘çš„ç¼“å­˜ã€‚
          restore-keys: |
            ${{ runner.os }}-cache-token-
      # --- ä¿®æ”¹ç»“æŸ ---

      - name: ğŸ”§ Init secrets
        uses: shine1594/secrets-to-env-action@master
        with:
          secrets: ${{ toJSON(secrets) }}
          secrets_env: production
          prefix_prod: ""
          file_name_prod: .env

      - name: ğŸ“¡ Init dependencies
        run: npm install

      - name: ğŸš€ Run
        uses: nick-fields/retry@master
        with:
          timeout_minutes: 30
          max_attempts: 3
          command: npm start
      
      # ä¹‹å‰çš„ `save` æ­¥éª¤å·²ç»è¢«åˆå¹¶ï¼Œæ‰€ä»¥è¿™é‡Œåˆ æ‰å®ƒ

      - name: ğŸš— Keep Running
        # å¢åŠ ä¸€ä¸ªæ¡ä»¶åˆ¤æ–­ï¼šä»…åœ¨å®šæ—¶ä»»åŠ¡è§¦å‘æ—¶æ‰æ‰§è¡Œè‡ªåŠ¨æäº¤
        if: github.event_name == 'schedule'
        run: |
          git config --local user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
          git config --local user.name "${{ github.actor }}"
          git remote set-url origin https://${{ github.actor }}:${{ github.token }}@github.com/${{ github.repository }}
          git pull --rebase --autostash
          # å¢åŠ ä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœ .token æ–‡ä»¶æœ‰å˜åŒ–æ‰æäº¤ï¼Œé¿å…æ— æ„ä¹‰çš„ "Keep Running" æäº¤
          if ! git diff --quiet .token; then
            git add .token
            git commit -m "feat: Update token by schedule"
          else
            git commit --allow-empty -m "ci: Keep workflow running"
          fi
          git push

      - name: ğŸ‰ Delete old workflow run
        uses: Mattraks/delete-workflow-runs@main
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 50

